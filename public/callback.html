<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Payment Processing</title>
</head>
<body>
    <h1>Processing payment...</h1>
    <p id="status">Please wait...</p>
    
    <script>
        // Get URL parameters from Pesapal callback
        const urlParams = new URLSearchParams(window.location.search);
        const orderTrackingId = urlParams.get('OrderTrackingId');
        const merchantReference = urlParams.get('OrderMerchantReference');
        
        // If this is just Pesapal testing the IPN URL
        if (!orderTrackingId) {
            // Respond to Pesapal's test
            document.getElementById('status').textContent = 'IPN endpoint active';
            
            // Also log to console
            console.log('IPN test received');
        } else {
            // This is an actual payment callback
            document.getElementById('status').textContent = 'Payment received! Verifying...';
            
            // Forward to the Worker API for processing
            fetch('https://voucher-api.mobilehubugandainfo.workers.dev/api/payment/callback?OrderTrackingId=' + orderTrackingId + '&OrderMerchantReference=' + merchantReference)
                .then(response => response.text())
                .then(data => {
                    // Redirect to voucher page
                    window.location.href = '/voucher.html?order=' + orderTrackingId;
                })
                .catch(error => {
                    document.getElementById('status').textContent = 'Error processing payment. Please contact support.';
                    console.error('Error:', error);
                });
        }
    </script>
</body>
</html>
